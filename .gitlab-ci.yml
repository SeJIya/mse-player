stages:
  - prepare_environment
  - dependencies
  - build
  - upload
  - notify
  - deploy

prepare_environment:
  stage: prepare_environment
  script:
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG ci_prepare

dependencies:
  stage: dependencies
  script:
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG ci_dependencies
  dependencies:
    - prepare_environment

build_package:
  stage: build
  script:
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG ci_build_package
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG ci_extract_package
  artifacts:
    paths:
      - dist
    expire_in: 1 day
  dependencies:
    - dependencies

build_frontci:
  stage: build
  script:
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG ci_build_frontci
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG ci_extract_frontci
  artifacts:
    paths:
      - frontci
    expire_in: 1 day
  dependencies:
    - dependencies

upload_frontci:
  stage: upload
  dependencies:
    - build_frontci
  script:
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG FRONTCI_USER=$FRONTCI_USER FRONTCI_PASS=$FRONTCI_PASS ci_upload_frontci

notify:
  stage: notify
  script:
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG SLACKURL=$SLACKURL ci_notify

deploy_npm:
  stage: deploy
  script:
    - make -f deploy/Makefile BRANCH=$CI_COMMIT_REF_SLUG NPM_AUTH_TOKEN=$NPM_AUTH_TOKEN ci_deploy_npm
  dependencies:
    - build_package
  allow_failure: true
  only:
    refs:
      - tags

deploy_review:
  stage: deploy
  script:
    - echo "Deploy a review app"
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: http://front-ci.erlyvideo.ru/dist/mse-player/ac-9229-mse-player-ci-cd/19.8.3-40-gf47962e/index.html
  only:
    - branches
  except:
    - master

# deploy_staging:
#   stage: deploy
#   script:
#     - echo "Deploy to staging server"
#   environment:
#     name: staging
#     url: https://staging.example.com
#   only:
#   - master
